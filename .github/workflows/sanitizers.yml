name: Sanitizers

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  asan:
    name: AddressSanitizer
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build clang

      - name: Configure with ASan
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang \
            -DAGIM_ENABLE_ASAN=ON

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Test with ASan
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1:print_stats=1
        run: cd build && ctest --output-on-failure -j$(nproc)

  tsan:
    name: ThreadSanitizer
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build clang

      - name: Configure with TSan
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang \
            -DAGIM_ENABLE_TSAN=ON

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Test with TSan
        env:
          TSAN_OPTIONS: abort_on_error=1:second_deadlock_stack=1
        run: |
          cd build
          # Run multi-threaded tests specifically
          ctest --output-on-failure -R "worker|parallel|concurrent|mailbox" -j1

  ubsan:
    name: UndefinedBehaviorSanitizer
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build clang

      - name: Configure with UBSan
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang \
            -DAGIM_ENABLE_UBSAN=ON

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Test with UBSan
        env:
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
        run: cd build && ctest --output-on-failure -j$(nproc)

  msan:
    name: MemorySanitizer
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build clang

      - name: Configure with MSan
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang \
            -DAGIM_ENABLE_MSAN=ON

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Test with MSan
        env:
          MSAN_OPTIONS: abort_on_error=1
        run: cd build && ctest --output-on-failure -j$(nproc)
